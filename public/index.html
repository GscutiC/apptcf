<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <!-- Favicon ser√° aplicado din√°micamente por DOMConfigService -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="ScutiTec - Soluciones empresariales sostenibles" />
    <title>ScutiTec</title>
    
    <!-- ============================================
         RESOURCE HINTS - Performance Optimization
         ============================================ -->
    
    <!-- DNS Prefetch - Resolver DNS antes de las requests -->
    <link rel="dns-prefetch" href="http://localhost:8000" />
    
    <!-- Preconnect - Establecer conexi√≥n temprana con el backend -->
    <link rel="preconnect" href="http://localhost:8000" crossorigin />
    
    <!-- Preload - Cargar recursos cr√≠ticos primero -->
    <link rel="preload" href="/src/index.tsx" as="script" />
    <link rel="preload" href="/src/index.css" as="style" />
    
    <!-- Pre-carga de configuraci√≥n ANTES de React -->
    <script>
      (function() {
        // Evitar aplicaci√≥n duplicada de configuraci√≥n
        if (window.__CONFIG_APPLIED__) {
          return;
        }
        
        const API_URL = 'http://localhost:8000';
        const CONFIG_CACHE_KEY = 'interface-config-cache';
        const CONFIG_TIMESTAMP_KEY = 'interface-config-timestamp';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
        
        // Funci√≥n para aplicar configuraci√≥n al DOM inmediatamente
        function applyConfigToDOM(config) {
          try {
            // Evitar re-aplicaci√≥n si ya se aplic√≥
            if (window.__CONFIG_APPLIED__) {
              return;
            }
            
            if (!config || !config.theme) return;
            
            const root = document.documentElement;
            
            // Aplicar colores primarios
            if (config.theme.colors && config.theme.colors.primary) {
              const primary = config.theme.colors.primary;
              Object.entries(primary).forEach(([shade, color]) => {
                root.style.setProperty(`--color-primary-${shade}`, color);
              });
            }
            
            // Aplicar colores secundarios
            if (config.theme.colors && config.theme.colors.secondary) {
              const secondary = config.theme.colors.secondary;
              Object.entries(secondary).forEach(([shade, color]) => {
                root.style.setProperty(`--color-secondary-${shade}`, color);
              });
            }
            
            // Aplicar colores de acento
            if (config.theme.colors && config.theme.colors.accent) {
              const accent = config.theme.colors.accent;
              Object.entries(accent).forEach(([shade, color]) => {
                root.style.setProperty(`--color-accent-${shade}`, color);
              });
            }
            
            // Aplicar colores neutros
            if (config.theme.colors && config.theme.colors.neutral) {
              const neutral = config.theme.colors.neutral;
              Object.entries(neutral).forEach(([shade, color]) => {
                root.style.setProperty(`--color-neutral-${shade}`, color);
              });
            }
            
            // Aplicar colores de success
            if (config.theme.colors && config.theme.colors.success) {
              const success = config.theme.colors.success;
              Object.entries(success).forEach(([shade, color]) => {
                root.style.setProperty(`--color-success-${shade}`, color);
              });
            }
            
            // Aplicar t√≠tulo de la aplicaci√≥n
            if (config.branding && config.branding.appName) {
              document.title = config.branding.appName;
            }
            
            // Aplicar favicon si existe
            if (config.branding && config.branding.faviconUrl) {
              const favicon = document.querySelector('link[rel="icon"]');
              if (favicon) {
                favicon.href = config.branding.faviconUrl;
              } else {
                const newFavicon = document.createElement('link');
                newFavicon.rel = 'icon';
                newFavicon.href = config.branding.faviconUrl;
                document.head.appendChild(newFavicon);
              }
            }
            
            // Marcar como aplicada
            window.__CONFIG_APPLIED__ = true;
            console.log('‚úÖ Configuraci√≥n aplicada al DOM antes de React');
          } catch (error) {
            console.warn('‚ö†Ô∏è Error aplicando config al DOM:', error);
          }
        }
        
        // Intentar cargar desde localStorage primero (cache)
        try {
          const cachedConfig = localStorage.getItem(CONFIG_CACHE_KEY);
          const timestamp = localStorage.getItem(CONFIG_TIMESTAMP_KEY);
          
          if (cachedConfig && timestamp) {
            const age = Date.now() - parseInt(timestamp);
            
            if (age < CACHE_DURATION) {
              const config = JSON.parse(cachedConfig);
              window.__INITIAL_CONFIG__ = config;
              applyConfigToDOM(config);
              // Verificar que body existe antes de acceder a classList
              if (document.body) {
                document.body.classList.add('config-loaded');
              }
              console.log('‚ö° Config cargada desde localStorage (cache)');
              return; // Salir si la cache es v√°lida
            } else {
              console.log('üóëÔ∏è Cache expirada, cargando desde servidor...');
            }
          }
        } catch (error) {
          console.warn('Error leyendo cache:', error);
        }
        
        // Si no hay cache v√°lida, cargar desde el backend
        fetch(`${API_URL}/api/interface-config/current/safe`)
          .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
          })
          .then(config => {
            // Guardar en window para que React lo use
            window.__INITIAL_CONFIG__ = config;
            
            // Guardar en localStorage para futura carga r√°pida
            try {
              localStorage.setItem(CONFIG_CACHE_KEY, JSON.stringify(config));
              localStorage.setItem(CONFIG_TIMESTAMP_KEY, Date.now().toString());
            } catch (e) {
              console.warn('No se pudo guardar en localStorage:', e);
            }
            
            // Aplicar al DOM inmediatamente
            applyConfigToDOM(config);
            
            // Marcar como cargado (verificar que body existe)
            if (document.body) {
              document.body.classList.add('config-loaded');
            }
            
            console.log('‚úÖ Config cargada desde backend y aplicada');
          })
          .catch(error => {
            console.warn('‚ö†Ô∏è No se pudo cargar config desde backend:', error);
            
            // Usar config de emergencia consistente con defaultConfigs.ts (ScutiTec)
            const emergencyConfig = {
              id: 'emergency',
              branding: {
                appName: 'ScutiTec',
                appDescription: 'Soluciones empresariales sostenibles',
                companyName: 'ScutiTec'
              },
              theme: {
                name: 'ScutiTec Default',
                mode: 'light',
                colors: {
                  primary: {
                    '50': '#f8fafc', '100': '#f1f5f9', '200': '#e2e8f0',
                    '300': '#cbd5e1', '400': '#94a3b8', '500': '#64748b',
                    '600': '#475569', '700': '#334155', '800': '#1e293b',
                    '900': '#0f172a'
                  },
                  secondary: {
                    '50': '#f8fafc', '100': '#f1f5f9', '200': '#e2e8f0',
                    '300': '#cbd5e1', '400': '#94a3b8', '500': '#64748b',
                    '600': '#475569', '700': '#334155', '800': '#1e293b',
                    '900': '#0f172a'
                  },
                  accent: {
                    '50': '#f8fafc', '100': '#f1f5f9', '200': '#e2e8f0',
                    '300': '#cbd5e1', '400': '#94a3b8', '500': '#64748b',
                    '600': '#475569', '700': '#334155', '800': '#1e293b',
                    '900': '#0f172a'
                  },
                  neutral: {
                    '50': '#f9fafb', '100': '#f3f4f6', '200': '#e5e7eb',
                    '300': '#d1d5db', '400': '#9ca3af', '500': '#6b7280',
                    '600': '#4b5563', '700': '#374151', '800': '#1f2937',
                    '900': '#111827'
                  },
                  success: {
                    '50': '#f0fdf4', '100': '#dcfce7', '200': '#bbf7d0',
                    '300': '#86efac', '400': '#4ade80', '500': '#22c55e',
                    '600': '#16a34a', '700': '#15803d', '800': '#166534',
                    '900': '#14532d'
                  }
                }
              }
            };
            
            window.__INITIAL_CONFIG__ = emergencyConfig;
            applyConfigToDOM(emergencyConfig);
            // Verificar que body existe antes de acceder a classList
            if (document.body) {
              document.body.classList.add('config-loaded');
            }
            
            console.log('üö´ Usando configuraci√≥n de emergencia');
          });
      })();
    </script>
    
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      code {
        font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
          monospace;
      }

      * {
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <noscript>Necesitas tener JavaScript habilitado para usar esta aplicaci√≥n.</noscript>
    <div id="root"></div>
  </body>
</html>